$: << File.expand_path('../../../lib', __FILE__)

require 'bundler/setup'
require 'json'
require 'benchmark'
require 'autobahn'


n = 1000
messages = DATA.readlines.map { |line| JSON.parse(line) }

msgpack_encoder = Autobahn::MsgPackEncoder.new
lzf_encoder = Autobahn::LzfEncoder.new(msgpack_encoder)
msgpack_lzf_encoder = Autobahn::MsgPackLzfEncoder.new
msgpack_lzf_symbol_encoder = Autobahn::MsgPackLzfEncoder.new(:symbolize_keys => true)

def encode_decode(encoder, messages, n)
  n.times do
    messages.each do |m|
      encoder.decode(encoder.encode(m))
    end
  end
end

Benchmark.bm(35) do |x|
  x.report('MsgPackEncoder + LzfEncoder')        { encode_decode(lzf_encoder, messages, n) }
  x.report('MsgPackLzfEncoder')                  { encode_decode(msgpack_lzf_encoder, messages, n) }
  x.report('MsgPackLzfEncoder + symbolize_keys') { encode_decode(msgpack_lzf_symbol_encoder, messages, n) }
end

__END__
{"agent_version":"1175-JS","client_timestamp":7114,"media_key":"STMPBQZTZ5GL","user_id":"M4NMNTD1NTQK","website_name":"gp.se","click_enabled":true,"media_type":["DIV"],"node_count":1,"page_dimension":[1344,10321],"placement_kind":"absolute","placement_name":"eniro-sponsored-links-element-rightcol","script_access":true,"session_id":"M4NMO0PHC71S","node_visibility":[0],"timestamp":1338076800821,"ip":"62.107.17.94","platform":"RFM","pageview_ref":"M4NMNTQ47OT80000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","referrer_domain":"mediavejviseren.dk","sample_rate":1,"last_timestamp":1338076800821,"last_client_timestamp":26790,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Internet Explorer","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"301x242","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":7117,"media_key":"STMPBQZTZ5GL","user_id":"M4NMNTD1NTQK","website_name":"gp.se","click_enabled":false,"wrapper_url":"http://biowebb-data.s3.amazonaws.com/pages/12/city/56/date/today/index.html","media_type":["IFRAME"],"node_count":1,"page_dimension":[1344,10321],"placement_kind":"absolute","placement_name":"sfannonsen","script_access":true,"session_id":"M4NMO0RAF203","node_visibility":[0],"timestamp":1338076800821,"ip":"62.107.17.94","platform":"RFM","pageview_ref":"M4NMNTQ47OT80000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","referrer_domain":"mediavejviseren.dk","sample_rate":1,"last_timestamp":1338076800821,"last_client_timestamp":26790,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Internet Explorer","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"1000x1000","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":2180,"media_key":"STMPBQZTZ5GL","user_id":"LU3RNWLG54MH","website_name":"gp.se","click_enabled":true,"load_url":"http://fusion.adtoma.com/11C883A096B/11C88E6CA70.jpg","media_type":["IMG"],"node_count":1,"page_dimension":[1280,10173],"placement_kind":"absolute","placement_name":"helsida_1","script_access":true,"session_id":"M4NMO0P6UQWX","tag_id":"122554817110","node_visibility":[0],"timestamp":1338076803103,"ip":"217.211.1.119","platform":"RFM","pageview_ref":"M4NMO041HOZL0000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076803103,"last_client_timestamp":2530,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Chrome","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"440x400","share_of_view":0.0,"external_ids":{},"valid":true,"ideal_revenue":0.152245258,"currency":"SEK","has_ideal_revenue?":true}
{"agent_version":"1175-JS","client_timestamp":2166,"media_key":"STMPBQZTZ5GL","user_id":"LU3RNWLG54MH","website_name":"gp.se","click_enabled":true,"load_url":"http://media.dealie.se/dealie/goteborg/210x300","media_type":["IMG"],"node_count":1,"page_dimension":[1280,10173],"placement_kind":"absolute","placement_name":"dealie","script_access":true,"session_id":"M4NMO2816F4X","node_visibility":[0],"timestamp":1338076803035,"ip":"217.211.1.119","platform":"RFM","pageview_ref":"M4NMO041HOZL0000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076803035,"last_client_timestamp":2530,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Chrome","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"portrait","ad_dimensions":"210x300","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":2165,"media_key":"STMPBQZTZ5GL","user_id":"LU3RNWLG54MH","website_name":"gp.se","click_enabled":false,"wrapper_url":"http://biowebb-data.s3.amazonaws.com/pages/12/city/56/date/today/index.html","media_type":["IFRAME"],"node_count":1,"page_dimension":[1280,10173],"placement_kind":"absolute","placement_name":"sfannonsen","script_access":true,"session_id":"M4NMO2SN6RAL","node_visibility":[0],"timestamp":1338076803035,"ip":"217.211.1.119","platform":"RFM","pageview_ref":"M4NMO041HOZL0000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076803035,"last_client_timestamp":2530,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Chrome","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"1000x1000","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":1685,"media_key":"STMPBQZTZ5GL","user_id":"M4NMO5VVS0EN","website_name":"gp.se","click_enabled":false,"load_url":"http://www.gp.se/polopoly_fs/1.954757.1337948308!/image/1632830087.png","media_type":["IMG","IMG","IMG","IMG","IMG","IMG","IMG","IMG"],"node_count":1,"page_dimension":[1450,10173],"placement_kind":"absolute","placement_name":"uppslag","script_access":true,"session_id":"M4NMO5CITC8X","tag_id":"122556064100","node_visibility":[0,0,0,0,0,0,0,0],"timestamp":1338076808617,"ip":"83.233.2.132","platform":"RFM","pageview_ref":"M4NMO5PSBAC70000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076808617,"last_client_timestamp":12815,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Safari","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"landscape","ad_dimensions":"434x72","share_of_view":0.0,"external_ids":{},"valid":true,"ideal_revenue":0.166127072,"currency":"SEK","has_ideal_revenue?":true}
{"agent_version":"1175-JS","client_timestamp":1374,"media_key":"STMPBQZTZ5GL","user_id":"M4NMO5VVS0EN","website_name":"gp.se","click_enabled":true,"load_url":"http://media.dealie.se/dealie/goteborg/210x300","media_type":["IMG"],"node_count":1,"page_dimension":[1450,10173],"placement_kind":"absolute","placement_name":"dealie","script_access":true,"session_id":"M4NMO6TST0J3","node_visibility":[0],"timestamp":1338076808364,"ip":"83.233.2.132","platform":"RFM","pageview_ref":"M4NMO5PSBAC70000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076808364,"last_client_timestamp":12815,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Safari","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"portrait","ad_dimensions":"210x300","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":1801,"media_key":"STMPBQZTZ5GL","user_id":"LWKMZ1UTN51Z","website_name":"gp.se","click_enabled":true,"media_type":["DIV"],"node_count":1,"page_dimension":[1279,10173],"placement_kind":"absolute","placement_name":"eniro-sponsored-links-element-rightcol","script_access":true,"session_id":"M4NMO5B41DYJ","node_visibility":[0],"timestamp":1338076805429,"ip":"77.110.16.158","platform":"RFM","pageview_ref":"M4NMO3IBL7770000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076805429,"last_client_timestamp":6357,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Safari","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"302x253","share_of_view":0.0,"external_ids":{},"valid":true}
{"agent_version":"1175-JS","client_timestamp":1930,"media_key":"STMPBQZTZ5GL","user_id":"LWKMZ1UTN51Z","website_name":"gp.se","click_enabled":false,"load_url":"http://www.gp.se/polopoly_fs/1.954837.1337949932!/image/2762152958.jpg","media_type":["IMG","IMG","IMG","IMG","IMG","IMG","IMG","IMG"],"node_count":1,"page_dimension":[1279,10173],"placement_kind":"absolute","placement_name":"uppslag","script_access":true,"session_id":"M4NMO3GOB69R","tag_id":"122556064140","node_visibility":[0,0,0,0,0,0,0,0],"timestamp":1338076805898,"ip":"77.110.16.158","platform":"RFM","pageview_ref":"M4NMO3IBL7770000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076805898,"last_client_timestamp":6357,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Safari","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"landscape","ad_dimensions":"440x135","share_of_view":0.0,"external_ids":{},"valid":true,"ideal_revenue":0.166127072,"currency":"SEK","has_ideal_revenue?":true}
{"agent_version":"1175-JS","client_timestamp":1804,"media_key":"STMPBQZTZ5GL","user_id":"LWKMZ1UTN51Z","website_name":"gp.se","click_enabled":false,"wrapper_url":"http://biowebb-data.s3.amazonaws.com/pages/12/city/56/date/today/index.html","media_type":["IFRAME"],"node_count":1,"page_dimension":[1279,10173],"placement_kind":"absolute","placement_name":"sfannonsen","script_access":true,"session_id":"M4NMO50A2A3C","node_visibility":[0],"timestamp":1338076805429,"ip":"77.110.16.158","platform":"RFM","pageview_ref":"M4NMO3IBL7770000","category":"frontpage","embed_url":"http://www.gp.se/","canonical_path":"www.gp.se/","sample_rate":1,"last_timestamp":1338076805429,"last_client_timestamp":6357,"pre_crunched":true,"media_rating":0.0,"average_visibility":0,"browser":"Safari","device_type":"computer","has_activity_updates":true,"engagement":false,"engagement_duration":0,"time_to_engagement":0,"redirect_url":null,"click":false,"time_to_click_thru":0,"has_error":false,"ad_orientation":"square","ad_dimensions":"1000x1000","share_of_view":0.0,"external_ids":{},"valid":true}
